image: golang:1.11

variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
- test
- build

vet:
  stage: test
  script:
  - make vet

test:
  stage: test
  script:
  - make test

build:
  only:
  - master
  stage: build
  tags:
  - docker
  image: docker:stable
  services:
  - docker:dind
  script:
  - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
  - docker build --pull -t eventter/mq -f mq/Dockerfile .
  - docker push eventter/mq

build_web:
  only:
  - master
  stage: build
  image: debian:stable
  script:
  - apt-get update
  - apt-get install --no-install-recommends --no-install-suggests ca-certificates git openssh-client wget -y
  - wget https://github.com/gohugoio/hugo/releases/download/v0.53/hugo_0.53_Linux-64bit.deb -O /tmp/hugo.deb
  - dpkg -i /tmp/hugo.deb
  - eval $(ssh-agent -s)
  - echo "$WEB_SSH_PRIVATE_KEY" | ssh-add -
  - cd web
  - git clone git@github.com:eventter/eventter.github.io.git public
  - hugo
  - cd public
  - git add .
  - if git diff --cached --exit-code > /dev/null; then exit 0; fi # no changes
  - git commit -m "build eventter/eventter#$CI_COMMIT_SHA ($CI_COMMIT_TITLE)"
  - git push origin master
