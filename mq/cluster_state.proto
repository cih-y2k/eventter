syntax = "proto3";

package io.eventter.mq;

import "client/eventtermq.proto";
import "gogoproto/gogo.proto";
import "google/protobuf/duration.proto";

option go_package = "mq";

message ClusterState {
    uint64 index = 1;
    uint64 current_segment_id = 2 [(gogoproto.customname) = "CurrentSegmentID"];
    repeated ClusterNamespace namespaces = 3;
    repeated ClusterSegment open_segments = 4;
    repeated ClusterSegment closed_segments = 5;
}

message ClusterNamespace {
    string name = 1;
    repeated ClusterTopic topics = 2;
    repeated ClusterConsumerGroup consumer_groups = 3;
}

message ClusterTopic {
    string name = 1;
    string type = 2;
    uint32 shards = 3;
    uint32 replication_factor = 4;
    google.protobuf.Duration retention = 5 [(gogoproto.nullable) = false, (gogoproto.stdduration) = true];
}

message ClusterConsumerGroup {
    string name = 1;
    repeated Binding bindings = 2;
    uint32 shards = 3;

    message Binding {
        string topic_name = 1;
        string routing_key = 2;
    }
}

message ClusterSegment {
    uint64 id = 1 [(gogoproto.customname) = "ID"];
    NamespaceName topic = 2 [(gogoproto.nullable) = false];
    bytes first_message_id = 3 [(gogoproto.customname) = "FirstMessageID"];
    bytes last_message_id = 4 [(gogoproto.customname) = "LastMessageID"];
    Nodes nodes = 5 [(gogoproto.nullable) = false];
    uint64 size = 6;
    bytes sha1 = 7;

    message Nodes {
        uint64 primary_node_id = 1 [(gogoproto.customname) = "PrimaryNodeID"];
        repeated uint64 replicating_node_ids = 2 [(gogoproto.customname) = "ReplicatingNodeIDs"];
        repeated uint64 done_node_ids = 3 [(gogoproto.customname) = "DoneNodeIDs"];
    }
}

message OpenSegmentCommand {
    uint64 id = 1 [(gogoproto.customname) = "ID"];
    NamespaceName topic = 2 [(gogoproto.nullable) = false];
    bytes first_message_id = 3 [(gogoproto.customname) = "FirstMessageID"];
    uint64 primary_node_id = 4 [(gogoproto.customname) = "PrimaryNodeID"];
}

message CloseSegmentCommand {
    uint64 id = 1 [(gogoproto.customname) = "ID"];
    uint64 done_node_id = 2 [(gogoproto.customname) = "DoneNodeID"];
    bytes last_message_id = 4 [(gogoproto.customname) = "LastMessageID"];
    uint64 size = 5;
    bytes sha1 = 6;
}

message Command {
    oneof command {
        ConfigureTopicRequest configure_topic = 1;
        DeleteTopicRequest delete_topic = 2;
        ConfigureConsumerGroupRequest configure_consumer_group = 3;
        DeleteConsumerGroupRequest delete_consumer_group = 4;
        OpenSegmentCommand open_segment = 5;
        CloseSegmentCommand close_segment = 6;
    }
}
